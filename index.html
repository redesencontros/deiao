<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DANÇA é isso aqui, ó</title>

<style>
* { box-sizing: border-box; }

html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
    color: white;
    background: #333635; /* background moved here */
}

/* ===== BACKGROUND CANVAS ===== */
#bgCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
}

/* ===== MAIN LAYER ===== */
#mainLayer {
    position: relative;
    z-index: 5;
    height: 100%;
    display: flex;
    flex-direction: column;
}

/* ===== HEADER ===== */
header {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 2vh 0 1vh 0;
}

#headerLogo {
    width: clamp(150px, 30vw, 300px);
}

/* ===== GAME CONTAINER ===== */
#gameContainer {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4vh;
    padding: 2vh 4vw 6vh 4vw;
}

#contentDisplay {
    width: min(95%, 1000px);
    height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    opacity: 1;
    transition: opacity 0.6s ease;
}

#contentDisplay.fade-out { opacity: 0; }

#contentDisplay img,
#contentDisplay video,
#contentDisplay audio,
#contentDisplay iframe {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

#contentDisplay video,
#contentDisplay audio {
    pointer-events: none;
}

#revealBtn {
    width: clamp(40px, 7vw, 75px);
    cursor: pointer;
    transition: transform 0.15s ease;
}

#revealBtn:hover { transform: translateY(-3px); }
#revealBtn:active { transform: scale(0.9); }

video::-webkit-media-controls,
video::-webkit-media-controls-enclosure {
    display: none !important;
}
</style>
</head>

<body>

<canvas id="bgCanvas"></canvas>

<div id="mainLayer">

<header>
    <img id="headerLogo"
         src="https://raw.githubusercontent.com/redesencontros/deiao-dados/main/DANÇA%20logo.png"
         alt="DANÇA">
</header>

<div id="gameContainer">
    <div id="contentDisplay"></div>

    <img id="revealBtn"
         src="https://raw.githubusercontent.com/redesencontros/deiao-dados/main/button-icon-png-21057.png"
         alt="Gerar conteúdo">
</div>

</div>

<script>

/* ===========================
   ===== DECK SYSTEM =====
=========================== */

const sheetURL = "links.txt";

let links = [];
let deck = [];
let isLoaded = false;

async function fetchSheet() {
    if (isLoaded) return;

    const response = await fetch(sheetURL + "?cacheBust=" + Date.now());
    const text = await response.text();

    links = text.split(/\r?\n/)
                .map(r => r.trim())
                .filter(r => r.length > 0);

    shuffleDeck();
    isLoaded = true;
    preloadUpcoming(3);
}

function shuffleDeck() {
    deck = [...links];
    for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
    }
}

function preloadUpcoming(count) {
    const upcoming = deck.slice(-count);
    upcoming.forEach(url => {
        if (url.match(/\.(jpeg|jpg|png|gif|webp)$/i)) {
            const img = new Image();
            img.src = url;
        }
    });
}

document.getElementById("revealBtn").addEventListener("click", loadNextFromDeck);

async function loadNextFromDeck() {

    const display = document.getElementById("contentDisplay");

    await fetchSheet();

    if (deck.length === 0) {
        shuffleDeck();
        preloadUpcoming(3);
    }

    const nextLink = deck.pop();

    display.classList.add("fade-out");

    setTimeout(() => {
        embedContent(nextLink);
        display.classList.remove("fade-out");
        preloadUpcoming(3);
    }, 300);
}

function embedContent(url) {

    const display = document.getElementById("contentDisplay");
    display.innerHTML = "";

    const lower = url.toLowerCase();

    if (lower.match(/\.(jpeg|jpg|png|gif|webp)$/)) {
        const img = document.createElement("img");
        img.src = url;
        display.appendChild(img);
        return;
    }

    if (lower.match(/\.(mp4|webm|ogg)$/)) {
        const video = document.createElement("video");
        video.src = url;
        video.autoplay = true;
        video.loop = true;
        video.muted = false;
        video.playsInline = true;
        video.preload = "auto";
        video.controls = false;
        video.style.pointerEvents = "none";
        display.appendChild(video);
        video.play().catch(()=>{});
        return;
    }

    if (lower.match(/\.(mp3|wav|ogg)$/)) {
        const audio = document.createElement("audio");
        audio.src = url;
        audio.autoplay = true;
        audio.loop = true;
        audio.preload = "auto";
        display.appendChild(audio);
        audio.play().catch(()=>{});
        return;
    }

    const iframe = document.createElement("iframe");
    iframe.src = url;
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    display.appendChild(iframe);
}

/* ===========================
   ===== BACKGROUND FLOCK =====
=========================== */

const canvas = document.getElementById("bgCanvas");
const ctx = canvas.getContext("2d");

let width, height;

function resize() {
    width = canvas.width = window.innerWidth;
    height = canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

const BOID_COUNT = 1200;
const boids = [];

class Boid {
    constructor() {
        this.x = Math.random() * width;
        this.y = Math.random() * height;
        this.vx = (Math.random() - 0.5) * 2;
        this.vy = (Math.random() - 0.5) * 2;
    }

    update() {
        this.x += this.vx;
        this.y += this.vy;

        if (this.x < 0 || this.x > width) this.vx *= -1;
        if (this.y < 0 || this.y > height) this.vy *= -1;
    }

    draw() {
        ctx.fillRect(this.x, this.y, 1, 1);
    }
}

for (let i = 0; i < BOID_COUNT; i++) {
    boids.push(new Boid());
}

function animate() {
    ctx.clearRect(0, 0, width, height);
    ctx.fillStyle = "white";

    for (let boid of boids) {
        boid.update();
        boid.draw();
    }

    requestAnimationFrame(animate);
}

animate();

</script>
</body>
</html>

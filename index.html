<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DANÇA é isso aqui, ó</title>

<style>
* { box-sizing: border-box; }

html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    font-family: Arial, sans-serif;
    color: white;
}

/* ===== BACKGROUND CANVAS ===== */
#bgcanvas {
    position: fixed;
    top: 0;
    left: 0;
    z-index: 0;
    background: #333635;
}

/* ===== MAIN LAYER ===== */
#mainLayer {
    position: relative;
    z-index: 2;
}

/* ===== HEADER ===== */
header {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 2vh 0 1vh 0;
}

#headerLogo {
    width: clamp(150px, 30vw, 300px);
}

/* ===== GAME CONTAINER ===== */
#gameContainer {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4vh;
    padding: 2vh 4vw 6vh 4vw;
}

#contentDisplay {
    width: min(95%, 1000px);
    height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    opacity: 1;
    transition: opacity 0.6s ease;
}

#contentDisplay.fade-out { opacity: 0; }

#contentDisplay img,
#contentDisplay video,
#contentDisplay audio,
#contentDisplay iframe,
#contentDisplay embed {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

/* HARD LOCK interaction */
#contentDisplay video,
#contentDisplay audio {
    pointer-events: none;
}

video::-webkit-media-controls,
video::-webkit-media-controls-enclosure {
    display: none !important;
}

/* ===== BUTTON ===== */
#revealBtn {
    width: clamp(40px, 7vw, 75px);
    cursor: pointer;
    transition: transform 0.15s ease, opacity 0.3s ease;
}

#revealBtn:hover { transform: translateY(-3px); }
#revealBtn:active { transform: scale(0.9); }

</style>
</head>

<body>

<canvas id="bgCanvas"></canvas>

<div id="mainLayer">

<header>
    <img id="headerLogo"
         src="https://raw.githubusercontent.com/redesencontros/deiao-dados/main/DANÇA%20logo.png"
         alt="DANÇA">
</header>

<div id="gameContainer">
    <div id="contentDisplay"></div>

    <img id="revealBtn"
         src="https://raw.githubusercontent.com/redesencontros/deiao-dados/main/button-icon-png-21057.png"
         alt="Gerar conteúdo">
</div>

</div>

<script>

/* ===========================
   ======= GAME LOGIC =======
=========================== */

const sheetURL = "links.txt";

let originalItems = [];
let deck = [];
let queue = [];
let isLoaded = false;

async function fetchSheet() {
    if (isLoaded) return;

    try {
        const response = await fetch(sheetURL + "?cacheBust=" + Date.now());
        const text = await response.text();

        const rows = text.split(/\r?\n/)
            .map(r => r.trim())
            .filter(r => r.length > 0);

        originalItems = rows.map(r => r.split("\t")[0]);

        reshuffleDeck();
        buildQueue();
        preloadNext();

        isLoaded = true;

    } catch (err) {
        console.error("Failed to load links.txt:", err);
    }
}

/* ===== DECK SYSTEM ===== */

function reshuffleDeck() {
    deck = [...originalItems];
    for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
    }
}

function buildQueue() {
    while (queue.length < 2 && deck.length > 0) {
        queue.push(deck.pop());
    }
}

function getNextItem() {

    if (queue.length === 0) {
        if (deck.length === 0) reshuffleDeck();
        buildQueue();
    }

    const item = queue.shift();

    if (deck.length === 0) reshuffleDeck();
    queue.push(deck.pop());

    preloadNext();
    return item;
}

/* ===== PRELOAD ===== */

let preloadedElement = null;

function preloadNext() {

    const next = queue[0];
    if (!next) return;

    const lower = next.toLowerCase();

    if (preloadedElement) {
        preloadedElement.remove?.();
        preloadedElement = null;
    }

    if (lower.match(/\.(jpeg|jpg|png|gif|webp)$/)) {
        const img = new Image();
        img.src = next;
        preloadedElement = img;
    }

    else if (lower.match(/\.(mp4|webm|ogg)$/)) {
        const video = document.createElement("video");
        video.src = next;
        video.preload = "auto";
        video.muted = true;
        video.playsInline = true;
        video.load();
        preloadedElement = video;
    }

    else if (lower.match(/\.(mp3|wav|ogg)$/)) {
        const audio = new Audio();
        audio.src = next;
        audio.preload = "auto";
        audio.load();
        preloadedElement = audio;
    }

    else if (lower.match(/\.pdf$/)) {
        fetch(next).catch(() => {});
    }
}

/* ===== FADE STOP ===== */

function stopAllMedia() {

    const FADE_DURATION = 1500;
    const FADE_STEPS = 20;
    const STEP_TIME = FADE_DURATION / FADE_STEPS;

    document.querySelectorAll("video, audio").forEach(media => {

        if (!media.muted && media.volume > 0) {

            let step = 0;
            const initialVolume = media.volume;

            const fade = setInterval(() => {

                step++;
                media.volume = Math.max(
                    0,
                    initialVolume * (1 - step / FADE_STEPS)
                );

                if (step >= FADE_STEPS) {
                    clearInterval(fade);
                    media.pause();
                    media.src = "";
                    media.load();
                    media.remove();
                }

            }, STEP_TIME);

        } else {
            media.pause();
            media.src = "";
            media.load();
            media.remove();
        }

    });

    document.querySelectorAll("iframe").forEach(frame => {
        frame.src = "about:blank";
        frame.remove();
    });
}

/* ===== BUTTON ===== */

document.getElementById("revealBtn")
    .addEventListener("click", loadNextFromDeck);

async function loadNextFromDeck() {

    const display = document.getElementById("contentDisplay");

    await fetchSheet();

    const nextLink = getNextItem();

    display.classList.add("fade-out");

    setTimeout(() => {

        stopAllMedia();
        display.innerHTML = "";
        embedContent(nextLink);
        display.classList.remove("fade-out");

    }, 300);
}

/* ===== EMBED CONTENT ===== */

function embedContent(url) {

    const display = document.getElementById("contentDisplay");
    const lower = url.toLowerCase();

    if (lower.match(/\.(jpeg|jpg|png|gif|webp)$/)) {
        const img = document.createElement("img");
        img.src = url;
        display.appendChild(img);
        return;
    }

  if (lower.match(/\.(mp4|webm|ogg)$/)) {

    const video = document.createElement("video");
    video.src = url;

    video.autoplay = true;
    video.playsInline = true;
    video.preload = "auto";
    video.controls = false;
    video.disablePictureInPicture = true;
    video.setAttribute("controlsList", "nodownload nofullscreen noremoteplayback");
    video.style.pointerEvents = "none";

    // FORCE LOOP (bulletproof)
    video.addEventListener("ended", () => {
        video.currentTime = 0;
        video.play().catch(() => {});
    });

    display.appendChild(video);

    video.play().catch(() => {});

    return;
}


    if (lower.match(/\.(mp3|wav|ogg)$/)) {
        const audio = new Audio();
        audio.src = url;
        audio.autoplay = true;
        audio.loop = true;
        audio.preload = "auto";
        audio.style.display = "none";
        display.appendChild(audio);
        audio.play().catch(() => {});
        return;
    }

    if (lower.match(/\.pdf$/)) {
        const iframe = document.createElement("iframe");
        iframe.src = url;
        iframe.style.width = "100%";
        iframe.style.height = "100%";
        iframe.style.border = "none";
        display.appendChild(iframe);
        return;
    }

    const iframe = document.createElement("iframe");
    iframe.src = url;
    iframe.style.width = "100%";
    iframe.style.height = "100%";
    iframe.style.border = "none";
    display.appendChild(iframe);
}

</script>

<!-- BACKGROUND SCRIPT REMAINS EXACTLY AS YOU HAD IT -->

</body>
</html>



<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MPC Virtual</title>

<style>
html, body {
    height:100%;
    overflow:hidden;
    margin:0;
    background:transparent;
}

body{
    height:100%;
    display:flex;
    justify-content:center;
    align-items:center;
    font-family:Arial, sans-serif;
    user-select:none;
    padding:0;              /* ← REMOVE o padding vertical */
    box-sizing:border-box;
}

/* Mantido para não alterar estrutura */
#mpcBody{
    width:100%;
    flex:1;
    min-height:0;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    align-items:center;

    filter: blur(6px);
    transition: filter 0.4s ease;
}

/* Overlay superior */
#startOverlay {
    position: fixed;
    inset: 0;
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

/* Botão play */
#playButton {
    font-size: 22px;
    padding: 18px 40px;
    background: rgb(215, 196, 25);
    color: black;
    border: none;
    cursor: pointer;
    letter-spacing: 3px;
    transition: transform 0.1s ease, background 0.2s ease;
    font-family: "PlayFont", sans-serif;
}

@font-face {
    font-family: "PlayFont";
    src: url("https://redesencontros.github.io/dancaeissoaquio/assets/fonts/bozart.woff2") format("woff2");
    font-weight: normal;
    font-style: normal;
}

#playButton:active {
    transform: scale(0.95);
}

/* ===== REMOVIDO CORPO VISUAL ===== */

#mpc{
    height:92%;
    max-height:92%;

    aspect-ratio: 3 / 4;

    display:flex;
    flex-direction:column;
    justify-content:space-between;
    align-items:center;
}

/* ===== TELA ===== */

#screen{
    width:100%;
    flex:0 0 18%;  /* visor ocupa 18% da altura total */
    
    background:#1b3b1b;
    margin-bottom:3%;
    
    box-shadow: inset 0 0 15px #000;
    color:#7CFF7C;

    display:flex;
    align-items:center;
    justify-content:center;
}

#screenText{
    font-size:clamp(9px, 5vh, 16px);
}

#screenText.blink {
    animation: blinkText 0.15s steps(2, start) 6;
}

@keyframes blinkText {
    to { opacity: 0; }
}

/* ===== GRID ===== */

#pads{
    width:100%;
    flex:1;

    display:grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);

    gap:3%;
}

/* ===== PADS ULTRA FLAT ===== */

.pad{
    width:100%;
    
    background:#000;
    border-radius:4px;

    cursor:pointer;
    transition:
        background 0.12s ease,
        box-shadow 0.12s ease,
        transform 0.06s ease;

    box-shadow:none;
}

/* Estado ativo estilo Push */
.pad.active{
    background:#ff6a00;

    box-shadow:
        0 0 18px rgba(255,106,0,0.7);

    transform:scale(0.97);
}

</style>
</head>
<body>

<div id="startOverlay">
    <button id="playButton">Vai DJ!</button>
</div>

<div id="mpc">
    <div id="mpcBody">
        <div id="screen">
            <span id="screenText">é isso aqui, ó</span>
        </div>

        <div id="pads"></div>
    </div>
</div>

<script>
const screenText = document.getElementById("screenText");

let audioContext;
let baseBuffer;
let baseSource;
let padBuffers = {};
let currentPadSource = null;
let currentPadElement = null;
let masterCompressor;
let masterGain;

async function initBaseTrack() {
    const response = await fetch("../../mpc/audio/base.wav");
    const arrayBuffer = await response.arrayBuffer();
    baseBuffer = await audioContext.decodeAudioData(arrayBuffer);
    playBaseLoop();
}

function playBaseLoop() {
    baseSource = audioContext.createBufferSource();
    baseSource.buffer = baseBuffer;
    baseSource.loop = true;
    baseSource.connect(masterCompressor);
    baseSource.start(0);
}

async function loadPads() {
    for (let url of padSounds) {
        const response = await fetch(url);
        const arrayBuffer = await response.arrayBuffer();
        padBuffers[url] = await audioContext.decodeAudioData(arrayBuffer);
    }
}

const padSounds = [
"../../mpc/audio/danca.wav",
"../../mpc/audio/hiphop.wav",
"../../mpc/audio/funk.wav",
"../../mpc/audio/aovivo.wav",
"../../mpc/audio/lapragalera.wav",
"../../mpc/audio/caravaisertipoassim.wav",
"../../mpc/audio/senteopassim.wav",
"../../mpc/audio/passim.wav",
"../../mpc/audio/muitochocante.wav"
];

const screen = document.getElementById("screen");
const padContainer = document.getElementById("pads");

padSounds.forEach((sound)=>{
    const pad = document.createElement("div");
    pad.classList.add("pad");
    pad.dataset.sound = sound;
    padContainer.appendChild(pad);
    pad.addEventListener("pointerdown", () => triggerPad(pad));
});

function triggerPad(pad){
    const buffer = padBuffers[pad.dataset.sound];
    if (!buffer) return;

    const fileName = pad.dataset.sound.split("/").pop().replace(".wav", "");
    screenText.textContent = fileName;
    screenText.classList.remove("blink");
    void screenText.offsetWidth;
    screenText.classList.add("blink");

    const now = audioContext.currentTime;

    if (currentPadSource) {
        try {
            currentPadSource.gainNode.gain.cancelScheduledValues(now);
            currentPadSource.gainNode.gain.setValueAtTime(
                currentPadSource.gainNode.gain.value,
                now
            );
            currentPadSource.gainNode.gain.linearRampToValueAtTime(0, now + 0.005);
            currentPadSource.stop(now + 0.005);
        } catch(e){}
    }

    const source = audioContext.createBufferSource();
    const gainNode = audioContext.createGain();

    source.buffer = buffer;
    source.connect(gainNode);
    gainNode.connect(masterCompressor);

    gainNode.gain.setValueAtTime(1, now);
    source.start(now);

    source.gainNode = gainNode;
    currentPadSource = source;

    pad.classList.add("active");
    setTimeout(() => pad.classList.remove("active"), 120);
}

const overlay = document.getElementById("startOverlay");
const playButton = document.getElementById("playButton");

playButton.addEventListener("click", async () => {

    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }

    masterCompressor = audioContext.createDynamicsCompressor();
    masterCompressor.threshold.value = -18;
    masterCompressor.ratio.value = 4;
    masterCompressor.attack.value = 0.003;
    masterCompressor.release.value = 0.2;

    masterGain = audioContext.createGain();
    masterGain.gain.value = 1;

    masterCompressor.connect(masterGain);
    masterGain.connect(audioContext.destination);

    if (audioContext.state === "suspended") {
        await audioContext.resume();
    }

    await initBaseTrack();
    await loadPads();

    overlay.style.opacity = "0";
    overlay.style.pointerEvents = "none";

    const mpcBody = document.getElementById("mpcBody");
    mpcBody.style.filter = "blur(0px)";
});
</script>
</body>
</html>
